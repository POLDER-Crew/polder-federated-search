apiVersion: batch/v1
kind: Job
metadata:
  name: setup-gleaner
spec:
  template:
    metadata:
      name: setup-gleaner
    spec:
      restartPolicy: Never
      volumes:
      - name: gleaner-config
        configMap:
          name: gleaner-config
      - name: nabu-config
        configMap:
          name: nabu-config
      - name: gleaner-context
        emptyDir: {}
      dnsPolicy: None
      dnsConfig:
        nameservers:
          - 10.96.0.10
        searches:
        - {{ .Release.Namespace }}.svc.cluster.local
        - svc.cluster.local
        - cluster.local
        options:
        - name: ndots
          value: "5"
      initContainers:
        # Literally wait for Blazegraph to come up so we can create a namespace
      - name: wait-for-triplestore-up
        image: curlimages/curl:7.82.0
        command:
        - /bin/sh
        - -c
        # yes, this is how it has to work, no I am not happy about it
        - >
          set -x;
          while [ $(curl -sw '%{http_code}' "{{ include "gleaner.triplestore.endpoint" . }}" -o /dev/null) -ne 200 ]; do
            sleep 15;
          done
      # Next, create the graphdb repository that we want to use for this app
      - name: setup-triplestore
        image: curlimages/curl:7.82.0
        volumeMounts:
        - name: triplestore-config
          mountPath: /config
        command:
        - curl
        - -X
        - POST
        - -H
        - 'Content-Type:multipart/form-data'
        - 'config= |
          #
          # Sesame configuration template for the Polder repository
          #
          @prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>.
          @prefix rep: <http://www.openrdf.org/config/repository#>.
          @prefix sr: <http://www.openrdf.org/config/repository/sail#>.
          @prefix sail: <http://www.openrdf.org/config/sail#>.
          @prefix owlim: <http://www.ontotext.com/trree/owlim#>.

          [] a rep:Repository ;
              rep:repositoryID "polder" ;
              rdfs:label "Polder Federated Search App Repo" ;
              rep:repositoryImpl [
                  rep:repositoryType "graphdb:FreeSailRepository" ;
                  sr:sailImpl [
                      sail:sailType "graphdb:FreeSail" ;

                      owlim:owlim-license "" ;

                      owlim:base-URL "http://example.org/owlim#" ;
                      owlim:defaultNS "" ;
                      owlim:entity-index-size "10000000" ;
                      owlim:entity-id-size  "40" ;    # or 32
                      owlim:imports "" ;
                      owlim:repository-type "file-repository" ;
                      owlim:storage-folder "storage" ;
                      owlim:ruleset "rdfsplus-optimized" ;
                      # owlim:ruleset "owl-horst-optimized" ;
                      # owlim:ruleset "empty" ;

                      owlim:enable-context-index "true" ;

                      # Indexes to speed up the read queries
                      owlim:enablePredicateList "true" ;
                      owlim:enable-literal-index "true" ;
                      owlim:in-memory-literal-properties "true" ;

                      owlim:enable-optimization  "true" ;
                      owlim:check-for-inconsistencies "false" ;
                      owlim:disable-sameAs  "true" ;
                      owlim:transaction-mode "safe" ;
                      owlim:transaction-isolation "true" ;
                      owlim:query-timeout  "0" ;
                      owlim:query-limit-results  "0" ;
                      owlim:throw-QueryEvaluationException-on-timeout "false" ;
                      owlim:read-only "false" ;
                      owlim:nonInterpretablePredicates "http://www.w3.org/2000/01/rdf-schema#label;http://www.w3.org/1999/02/22-rdf-syntax-ns#type;http://www.ontotext.com/owlim/ces#gazetteerConfig;http://www.ontotext.com/owlim/ces#metadataConfig" ;
                  ]
              ].'
        - "{{- include "gleaner.triplestore.endpoint" . }}/rest/repositories"
        - --next
        - -X
        - POST
        - --header
        - 'Accept: application/json'
        # ?update parameter is literally the url-encoded contents of lucene-connector.sparql
        - "{{- include "gleaner.triplestore.endpoint" . }}repositories/polder/statements?update=PREFIX%20%3A%3Chttp%3A%2F%2Fwww.ontotext.com%2Fconnectors%2Flucene%23%3E%20PREFIX%20inst%3A%3Chttp%3A%2F%2Fwww.ontotext.com%2Fconnectors%2Flucene%2Finstance%23%3E%20INSERT%20DATA%20%7B%20%20%20%20%20inst%3Atext_search%20%3AcreateConnector%20'''%20%7B%20%20%20%22fields%22%3A%20%5B%20%20%20%20%20%7B%20%20%20%20%20%20%20%22fieldName%22%3A%20%22all%22%2C%20%20%20%20%20%20%20%22propertyChain%22%3A%20%5B%20%20%20%20%20%20%20%20%20%22%24literal%22%20%20%20%20%20%20%20%5D%2C%20%20%20%20%20%20%20%22indexed%22%3A%20true%2C%20%20%20%20%20%20%20%22stored%22%3A%20true%2C%20%20%20%20%20%20%20%22analyzed%22%3A%20true%2C%20%20%20%20%20%20%20%22multivalued%22%3A%20true%2C%20%20%20%20%20%20%20%22ignoreInvalidValues%22%3A%20false%2C%20%20%20%20%20%20%20%22facet%22%3A%20true%20%20%20%20%20%7D%20%20%20%5D%2C%20%20%20%22languages%22%3A%20%5B%5D%2C%20%20%20%22types%22%3A%20%5B%20%20%20%20%20%22https%3A%2F%2Fschema.org%2FDataset%22%2C%20%20%20%20%20%22https%3A%2F%2Fschema.org%2FDataCatalog%22%20%20%20%5D%2C%20%20%20%22readonly%22%3A%20false%2C%20%20%20%22detectFields%22%3A%20false%2C%20%20%20%22importGraph%22%3A%20false%2C%20%20%20%22skipInitialIndexing%22%3A%20false%2C%20%20%20%22boostProperties%22%3A%20%5B%5D%2C%20%20%20%22stripMarkup%22%3A%20false%20%7D%20'''%20.%20%7D"
        - --next
        - -X
        - POST
        - --header
        # ?update parameter is literally the url-encoded contents of geosparql.sparql
        - "{{- include "gleaner.triplestore.endpoint" . }}/repositories/polder/statements?update=PREFIX%20geosparql%3A%20%3Chttp%3A%2F%2Fwww.ontotext.com%2Fplugins%2Fgeosparql%23%3E%20%20INSERT%20DATA%20%7B%20%20%20%5B%5D%20geosparql%3Aenabled%20%22true%22%20.%20%7D"
      # Run gleaner setup, which creates cloud storage buckets
      - name: gleaner-setup
        image: nsfearthcube/gleaner:dev-v3.0.4-development
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        args:
        - -cfg
        - gleaner
        - -setup
        env:
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key:  minioAccessKey
              name: {{ .Release.Name }}-secrets
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key:  minioSecretKey
              name: {{ .Release.Name }}-secrets
        workingDir: /config
        volumeMounts:
        - name: gleaner-config
          mountPath: /config/gleaner.yaml
          subPath: gleaner.yaml
      # We need the latest schema.org context, so fetch it
      - name: get-contextfiles
        image: curlimages/curl:7.82.0
        command:
        - curl
        - -O
        - https://schema.org/version/latest/schemaorg-current-https.jsonld
        volumeMounts:
        - name: gleaner-context
          mountPath: /context
        workingDir: /context
      # Dynamically create the sitemap for BAS and put it somewhere
      # that Gleaner can use to crawl
      - name: build-bas-sitemap
        image: nein09/build-bas-sitemap:1.2
        env:
        - name: MINIO_CLIENT_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key:  minioAccessKey
              name: {{ .Release.Name }}-secrets
        - name: MINIO_CLIENT_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key:  minioSecretKey
              name: {{ .Release.Name }}-secrets
        - name: MINIO_SERVER_HOST
          value: {{ include "gleaner.s3system.endpoint" . }}
        - name: MINIO_SERVER_PORT_NUMBER
          value: "{{ .Values.s3system_service.api_port }}"
        volumeMounts:
        - name: gleaner-context
          mountPath: /context
        workingDir: /context
      # Finally, index our data repositories!
      - name: gleaner-initial-index
        image: nsfearthcube/gleaner:dev-v3.0.4-development
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        args:
        - -cfg
        - gleaner
        env:
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key:  minioAccessKey
              name: {{ .Release.Name }}-secrets
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key:  minioSecretKey
              name: {{ .Release.Name }}-secrets
        workingDir: /config
        volumeMounts:
        - name: gleaner-config
          mountPath: /config/gleaner.yaml
          subPath: gleaner.yaml
        - name: gleaner-context
          mountPath: /config
      containers:
      - name: write-to-triplestore
        image: bitnami/minio-client:2022
        env:
        - name: MINIO_CLIENT_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key:  minioAccessKey
              name: {{ .Release.Name }}-secrets
        - name: MINIO_CLIENT_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key:  minioSecretKey
              name: {{ .Release.Name }}-secrets
        - name: MINIO_SERVER_HOST
          value: {{ include "gleaner.s3system.endpoint" . }}
        - name: MINIO_SERVER_PORT_NUMBER
          value: "{{ .Values.s3system_service.api_port }}"
        command:
        # the first line of the following bash command is supposed to happen automatically, according to
        # the documentation on docker hub, but it does not.
        - /bin/bash
        - -c
        - >
          mc config host add minio "http://${MINIO_SERVER_HOST}:${MINIO_SERVER_PORT_NUMBER}" "${MINIO_CLIENT_ACCESS_KEY}" "${MINIO_CLIENT_SECRET_KEY}" &&
          for i in $(mc find minio/{{ .Values.storageNamespace }}/milled); do
            mc cat $i | curl -X POST -H 'Content-Type:text/rdf+n3;charset=utf-8' --data-binary  @- {{ include "gleaner.triplestore.endpoint" . }}/repositories/{{ .Values.storageNamespace }}/statements
          done
